{% extends "layout.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <span class="card-title">Freunde</span>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">ZurÃ¼ck</a>
    </div>

    <!-- Add Friend -->
    <div class="input-group" style="margin-bottom: 2rem;">
        <input type="text" id="user-search" placeholder="Nutzer finden..." onkeyup="searchUsers()">
        <div id="search-results" style="margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem;"></div>
    </div>

    <!-- Requests -->
    <div id="pending-section" style="display: none; margin-bottom: 2rem;">
        <h4 style="color: var(--secondary-color); margin-bottom: 1rem;">Anfragen</h4>
        <div id="pending-list" class="habit-list"></div>
    </div>

    <!-- Friends List -->
    <h4 style="color: var(--subtext-color); margin-bottom: 1rem;">Deine Freunde</h4>
    <div id="friends-list" class="habit-list">
        <!-- Friends injected here -->
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadFriends();
        loadPending();
    });

    let searchTimeout;
    function searchUsers() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
            const query = document.getElementById('user-search').value;
            const container = document.getElementById('search-results');
            container.innerHTML = '';

            if (query.length < 2) return;

            const res = await fetch('/api/search_users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });
            const users = await res.json();

            users.forEach(u => {
                const div = document.createElement('div');
                div.className = 'habit-item';
                div.innerHTML = `
                    <span>${u.username}</span>
                    ${getActionButton(u)}
                `;
                container.appendChild(div);
            });
        }, 500);
    }

    function getActionButton(user) {
        if (user.status === 'pending') return '<span style="color: var(--subtext-color); font-size: 0.8rem;">Angefragt</span>';
        if (user.status === 'msg_received') return '<button class="btn" style="padding: 0.3rem 0.8rem;" onclick="acceptFriend(' + user.id + ')">Annehmen</button>';
        if (user.status === 'accepted') return '<span style="color: var(--primary-color);">Freunde</span>';
        return `<button class="btn btn-secondary" style="padding: 0.3rem 0.8rem;" onclick="addFriend(${user.id})">Add</button>`;
    }

    async function addFriend(id) {
        await fetch('/api/add_friend', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id })
        });
        searchUsers(); // Refresh
    }

    async function acceptFriend(id) {
        await fetch('/api/accept_friend', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id })
        });
        loadPending();
        loadFriends();
        searchUsers();
    }

    async function loadPending() {
        const res = await fetch('/api/get_pending_requests');
        const reqs = await res.json();
        const container = document.getElementById('pending-list');
        const section = document.getElementById('pending-section');

        container.innerHTML = '';
        if (reqs.length > 0) {
            section.style.display = 'block';
            reqs.forEach(u => {
                const div = document.createElement('div');
                div.className = 'habit-item';
                div.innerHTML = `
                    <span>${u.username}</span>
                    <button class="btn" onclick="acceptFriend(${u.id})">Annehmen</button>
                `;
                container.appendChild(div);
            });
        } else {
            section.style.display = 'none';
        }
    }

    async function loadFriends() {
        const res = await fetch('/api/get_friends');
        const friends = await res.json();
        const container = document.getElementById('friends-list');

        container.innerHTML = '';
        friends.forEach(f => {
            const div = document.createElement('div');
            div.className = 'habit-item';
            div.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 30px; height: 30px; background: var(--surface-color); border-radius: 50%; display: flex; justify-content: center; align-items: center;">ðŸ‘¤</div>
                    <div style="display: flex; flex-direction: column;">
                        <span style="font-weight: 600;">${f.username}</span>
                        <span style="font-size: 0.8rem; color: var(--primary-color);">ðŸ”¥ Streak: ${f.streak}</span>
                    </div>
                </div>
                <button class="delete-btn" onclick="removeFriend(${f.id})">Entfernen</button>
            `;
            container.appendChild(div);
        });
    }

    async function removeFriend(id) {
        if (!confirm('Freund entfernen?')) return;
        await fetch('/api/remove_friend', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id })
        });
        loadFriends();
    }
</script>
{% endblock %}