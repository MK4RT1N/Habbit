{% extends "layout.html" %}

{% block content %}
<div class="flex flex-col min-h-full w-full max-w-5xl mx-auto py-4">

    <!-- Date Strip -->
    <div class="px-4 mb-8">
        <div id="date-strip-container" class="flex gap-3 overflow-x-auto no-scrollbar snap-x px-2 scroll-smooth">
            {% for d in week_calendar %}
            <div {% if d.is_today %}id="today-date-card" {% endif %}
                class="snap-center shrink-0 flex flex-col items-center justify-center w-[72px] h-[92px] rounded-[1.8rem] transition-all duration-500
                {% if d.is_today %}bg-primary text-background-dark shadow-[0_12px_24px_rgba(19,236,91,0.25)] scale-105{% else %}bg-white/5 text-gray-500 hover:bg-white/10{% endif %}">
                <span class="text-[10px] font-black uppercase tracking-widest mb-1 opacity-70">{{ d.day_name }}</span>
                <span class="text-2xl font-black">{{ d.day_num }}</span>
                {% if d.is_today %}
                <div class="mt-1.5 size-1 rounded-full bg-background-dark"></div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        window.addEventListener('load', () => {
            const todayCard = document.getElementById('today-date-card');
            if (todayCard) {
                todayCard.scrollIntoView({ behavior: 'auto', inline: 'center' });
            }
        });
    </script>

    <!-- Hero / Streak Card -->
    <div class="px-6 mb-12">
        <div
            class="relative overflow-hidden p-8 rounded-[2.5rem] bg-[#1a2e22] border border-white/5 shadow-2xl min-h-[220px] flex items-center">
            <!-- Complex Background Blur Effects (Simulating the Image) -->
            <div class="absolute -top-20 -right-20 w-64 h-64 bg-primary/20 rounded-full blur-[80px]"></div>
            <div class="absolute -bottom-20 -left-20 w-64 h-64 bg-blue-500/10 rounded-full blur-[80px]"></div>

            <div class="relative z-10 flex w-full items-center justify-between gap-6">
                <div class="flex-1">
                    <p class="text-[10px] font-black uppercase tracking-[0.3em] text-primary mb-3">Aktueller Streak</p>
                    <h2 id="streak-display-hero" class="text-4xl font-black text-white mb-1">0 Tage üî•</h2>
                    <p id="hero-progress-text" class="text-sm font-bold text-white/50 mb-8">1 von 2 erledigt</p>

                    <!-- Progress Bar Container -->
                    <div class="h-2 w-full max-w-[240px] bg-white/5 rounded-full overflow-hidden">
                        <div id="hero-bar"
                            class="h-full bg-primary transition-all duration-[1500ms] ease-out shadow-[0_0_10px_rgba(19,236,91,0.5)]"
                            style="width: 50%"></div>
                    </div>
                </div>

                <!-- Circular Progress -->
                <div class="relative flex items-center justify-center shrink-0">
                    <svg class="size-24 -rotate-90">
                        <circle cx="48" cy="48" r="40" stroke="currentColor" stroke-width="12" fill="transparent"
                            class="text-white/5" />
                        <circle id="hero-circle-path" cx="48" cy="48" r="40" stroke="currentColor" stroke-width="12"
                            fill="transparent" stroke-dasharray="0, 100" pathLength="100" stroke-linecap="round"
                            class="text-primary transition-all duration-[1500ms] ease-out" />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span id="hero-percentage" class="text-xl font-black text-white">50%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lists -->
    <main class="flex-grow space-y-12 px-6 pb-32">
        <!-- Tasks -->
        <section>
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-sm font-black text-white/40 uppercase tracking-[0.2em]">Aktuelle Aufgaben</h3>
            </div>
            <div id="task-list" class="space-y-4">
                <!-- Injected via JS -->
            </div>
        </section>

        <!-- Habits -->
        <section>
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-sm font-black text-white/40 uppercase tracking-[0.2em]">T√§gliche Habits</h3>
            </div>
            <div id="habit-list" class="space-y-4">
                <!-- Injected via JS -->
            </div>
        </section>
    </main>

    <!-- Floating Action Button -->
    <button onclick="openAddEntryModal()"
        class="fixed bottom-10 right-8 size-16 rounded-full bg-primary text-background-dark shadow-[0_15px_30px_rgba(19,236,91,0.3)] flex items-center justify-center hover:scale-110 active:scale-90 transition-all z-[100] transform translate-z-0">
        <span class="material-symbols-outlined font-black" style="font-size: 36px;">add</span>
    </button>
</div>

<!-- ADD ENTRY MODAL -->
<div id="add-entry-modal"
    class="hidden fixed inset-0 z-[100] bg-black/80 backdrop-blur-md flex items-end sm:items-center justify-center transition-all">
    <div
        class="w-full sm:max-w-lg bg-surface-dark rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 animate-slide-up sm:animate-zoom-in relative border-t border-white/5 shadow-2xl">
        <div class="flex items-center justify-between mb-8">
            <h2 id="entry-title" class="text-2xl font-black text-white tracking-tight">Neuer Eintrag</h2>
            <button onclick="closeAddEntryModal()"
                class="size-10 flex items-center justify-center rounded-full bg-white/5 text-gray-400 hover:text-white transition-all">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <!-- Type Selector -->
        <div class="flex bg-background-dark p-1.5 rounded-2xl mb-8 border border-white/5">
            <button id="tab-habit" onclick="switchEntryType('habit')"
                class="flex-1 py-3 rounded-xl text-xs font-black uppercase tracking-widest transition-all bg-surface-dark text-white shadow-md">
                Gewohnheit
            </button>
            <button id="tab-task" onclick="switchEntryType('task')"
                class="flex-1 py-3 rounded-xl text-xs font-black uppercase tracking-widest transition-all text-gray-500 hover:text-gray-300">
                Aufgabe
            </button>
        </div>

        <!-- Form Content -->
        <div class="space-y-6">
            <div class="space-y-2">
                <label class="text-[10px] font-black text-white/30 uppercase tracking-[0.2em] ml-1">Was m√∂chtest du
                    tun?</label>
                <div class="relative">
                    <input id="main-entry-input" type="text" placeholder="z.B. 30 Min Lesen"
                        class="w-full bg-background-dark border border-white/5 rounded-2xl p-5 text-white placeholder-white/20 focus:border-primary/50 focus:ring-1 focus:ring-primary/20 outline-none transition-all font-bold text-lg" />
                    <span id="entry-type-icon"
                        class="material-symbols-outlined absolute right-5 top-5 text-white/10">sentiment_satisfied</span>
                </div>
                <p id="entry-subtitle" class="text-xs text-white/20 font-medium ml-1">Best√§ndigkeit ist der Schl√ºssel.
                </p>
            </div>

            <!-- Habit Config -->
            <div id="habit-freq-section" class="space-y-6">
                <div class="space-y-3">
                    <label
                        class="text-[10px] font-black text-white/30 uppercase tracking-[0.2em] ml-1">H√§ufigkeit</label>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                        <button onclick="setFrequency('daily')" id="freq-daily"
                            class="freq-btn active px-5 py-2.5 rounded-xl bg-background-dark border border-white/5 text-white/40 text-[10px] font-black uppercase tracking-widest hover:border-white/10 transition-all">
                            T√§glich
                        </button>
                        <button onclick="setFrequency('weekly_flex')" id="freq-weekly"
                            class="freq-btn px-5 py-2.5 rounded-xl bg-background-dark border border-white/5 text-white/40 text-[10px] font-black uppercase tracking-widest hover:border-white/10 transition-all">
                            W√∂chentlich
                        </button>
                        <button onclick="setFrequency('specific')" id="freq-specific"
                            class="freq-btn px-5 py-2.5 rounded-xl bg-background-dark border border-white/5 text-white/40 text-[10px] font-black uppercase tracking-widest hover:border-white/10 transition-all">
                            Eigene Tage
                        </button>
                    </div>
                </div>

                <!-- Day Selector -->
                <div id="days-selector-modal" class="hidden space-y-3">
                    <div class="flex justify-between gap-1">
                        {% for day in ['Mo','Di','Mi','Do','Fr','Sa','So'] %}
                        <button id="modal-day-{{ loop.index0 }}" onclick="toggleDayModal({{ loop.index0 }})"
                            class="day-check-modal size-10 rounded-xl bg-background-dark border border-white/5 text-white/30 font-black text-[10px] uppercase hover:border-white/20 transition-all">
                            {{ day }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Habit Goal -->
            <div id="habit-goal-section" class="space-y-3">
                <label class="text-[10px] font-black text-white/30 uppercase tracking-[0.2em] ml-1">Ziel pro Tag /
                    Woche</label>
                <div class="flex items-center gap-6 bg-background-dark p-2 rounded-2xl border border-white/5 w-fit">
                    <button onclick="adjustTarget(-1)"
                        class="size-10 rounded-xl bg-white/5 flex items-center justify-center text-white hover:bg-white/10 transition-all">
                        <span class="material-symbols-outlined">remove</span>
                    </button>
                    <span id="target-display" class="text-2xl font-black text-white min-w-[20px] text-center">1</span>
                    <button onclick="adjustTarget(1)"
                        class="size-10 rounded-xl bg-white/5 flex items-center justify-center text-white hover:bg-white/10 transition-all">
                        <span class="material-symbols-outlined">add</span>
                    </button>
                </div>
            </div>

            <!-- Task Date -->
            <div id="task-date-section" class="hidden space-y-3">
                <label class="text-[10px] font-black text-white/30 uppercase tracking-[0.2em] ml-1">Datum</label>
                <select id="new-task-date-modal"
                    class="w-full bg-background-dark border border-white/5 rounded-2xl p-4 text-white font-bold outline-none appearance-none">
                    <!-- Populated by JS -->
                </select>
            </div>

            <!-- Social -->
            <div id="social-section" class="space-y-4 pt-4 border-t border-white/5">
                <label class="text-[10px] font-black text-white/30 uppercase tracking-[0.2em] ml-1">Gemeinsam mit
                    Freunden</label>
                <div id="friends-selector-modal" class="space-y-2 max-h-[150px] overflow-y-auto no-scrollbar">
                    <!-- Friends list injected here -->
                </div>
            </div>

            <button onclick="submitEntry()"
                class="w-full bg-primary text-background-dark p-5 rounded-2xl font-black uppercase tracking-widest hover:brightness-110 active:scale-[0.98] transition-all shadow-[0_10px_30px_rgba(19,236,91,0.3)] mt-8 flex items-center justify-center gap-3">
                <span id="submit-btn-icon" class="material-symbols-outlined font-black">add_circle</span>
                <span id="submit-btn-text">Eintrag erstellen</span>
            </button>
        </div>
    </div>
</div>

<!-- PREMIUM HABIT DETAILS MODAL -->
<div id="habit-details-modal" class="hidden fixed inset-0 z-[120] bg-background-dark flex flex-col overflow-hidden">
    <!-- Header -->
    <header
        class="flex items-center justify-between px-6 h-20 border-b border-white/5 bg-background-dark/95 backdrop-blur-xl shrink-0">
        <div class="flex items-center justify-start flex-1">
            <button onclick="closeDetails()"
                class="size-11 rounded-2xl bg-white/5 flex items-center justify-center text-white active:scale-90 transition-all border border-white/5">
                <span class="material-symbols-outlined" style="font-size: 24px;">arrow_back</span>
            </button>
        </div>

        <h2 class="text-white font-black tracking-widest uppercase text-xl text-center">HabitFlow</h2>

        <div class="flex items-center justify-end gap-3 flex-1">
            <button onclick="showInviteModal()"
                class="size-11 rounded-2xl bg-white/5 flex items-center justify-center text-white active:scale-90 transition-all border border-white/5">
                <span class="material-symbols-outlined" style="font-size: 24px;">person_add</span>
            </button>
            <button onclick="deleteCurrentHabit()"
                class="size-11 rounded-2xl bg-red-500/10 flex items-center justify-center text-red-500 active:scale-90 transition-all border border-red-500/10">
                <span class="material-symbols-outlined" style="font-size: 24px;">delete</span>
            </button>
        </div>
    </header>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto p-6 pb-32 no-scrollbar">
        <!-- Icon & Name -->
        <div class="text-center mb-12 pt-8">
            <div
                class="size-28 rounded-[2.8rem] bg-[#1a2e22] border border-white/5 mx-auto flex items-center justify-center mb-8 shadow-2xl">
                <span id="detail-icon-emoji" class="text-6xl">‚ú®</span>
            </div>
            <h2 id="detail-title" class="text-4xl font-black text-white mb-4 tracking-tight">Habit Name</h2>
            <p id="detail-subtitle" class="text-[10px] font-black text-white/20 uppercase tracking-[0.4em]">FREQUENCY
                INFO</p>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-4 gap-3 mb-12">
            <!-- Streak -->
            <div
                class="p-4 rounded-[1.8rem] bg-[#1a2e22] border border-white/5 text-center flex flex-col items-center justify-center min-h-[110px] shadow-sm">
                <p id="detail-streak-val" class="text-2xl font-black text-white mb-1 tracking-tighter">0</p>
                <p class="text-[8px] font-black text-white/30 uppercase tracking-[0.2em]">Streak</p>
            </div>
            <!-- Rate -->
            <div
                class="p-4 rounded-[1.8rem] bg-[#1a2e22] border border-white/5 text-center flex flex-col items-center justify-center min-h-[110px] shadow-sm">
                <p id="stat-rate" class="text-2xl font-black text-white mb-1 tracking-tighter">0%</p>
                <p class="text-[8px] font-black text-white/30 uppercase tracking-[0.1em]">Erfolgsrate</p>
            </div>
            <!-- Total -->
            <div
                class="p-4 rounded-[1.8rem] bg-[#1a2e22] border border-white/5 text-center flex flex-col items-center justify-center min-h-[110px] shadow-sm">
                <p id="stat-total" class="text-2xl font-black text-white mb-1 tracking-tight">0</p>
                <p class="text-[8px] font-black text-white/30 uppercase tracking-[0.2em]">Gesamt</p>
            </div>
            <!-- Best -->
            <div
                class="p-4 rounded-[1.8rem] bg-[#1a2e22] border border-white/5 text-center flex flex-col items-center justify-center min-h-[110px] shadow-sm">
                <p id="stat-best-streak" class="text-2xl font-black text-white mb-1 tracking-tight">0</p>
                <p class="text-[8px] font-black text-white/30 uppercase tracking-[0.2em]">Bestwert</p>
            </div>
        </div>

        <!-- Interaction -->
        <div class="space-y-4 mb-16 px-2">
            <button id="detail-checkin-btn" onclick="toggleHabitFromDetail()"
                class="w-full py-5 rounded-[2rem] bg-primary text-background-dark font-black uppercase tracking-[0.2em] shadow-[0_15px_30px_rgba(19,236,91,0.25)] hover:brightness-110 active:scale-[0.97] transition-all text-sm">
                Heute Einchecken
            </button>

        </div>

        <!-- History Section -->
        <div class="mb-14">
            <h3 class="text-[10px] font-black text-white/20 uppercase tracking-[0.5em] mb-10 px-2">Verlauf</h3>
            <div id="detail-calendar-grid" class="grid grid-cols-7 gap-3 px-2">
                <!-- JS populated -->
            </div>
        </div>

        <!-- Activity Section -->
        <div class="pb-20">
            <h3 class="text-[10px] font-black text-white/20 uppercase tracking-[0.5em] mb-10 px-2">Aktivit√§ten</h3>
            <div id="recent-activity-list" class="space-y-4 px-2">
                <!-- JS populated -->
            </div>
        </div>
    </div>
</div>

<div id="task-details-modal" class="hidden fixed inset-0 z-[120] bg-background-dark flex flex-col overflow-hidden">
    <header class="flex items-center justify-between px-6 h-20 border-b border-white/5">
        <button onclick="closeTaskDetails()"
            class="size-12 rounded-2xl bg-white/5 flex items-center justify-center text-white">
            <span class="material-symbols-outlined">arrow_back</span>
        </button>
        <h2 class="text-white font-black tracking-widest uppercase text-sm">Aufgabe</h2>
        <button onclick="deleteCurrentTask()"
            class="size-12 rounded-2xl bg-red-500/10 flex items-center justify-center text-red-500">
            <span class="material-symbols-outlined">delete</span>
        </button>
    </header>
    <div class="flex-1 flex flex-col items-center justify-center p-8 text-center">
        <div class="size-24 rounded-[2rem] bg-white/5 flex items-center justify-center mb-8 border border-white/5">
            <span class="material-symbols-outlined text-5xl text-blue-400">assignment</span>
        </div>
        <h2 id="task-detail-title" class="text-4xl font-black text-white mb-4">Titel</h2>
        <p id="task-detail-date" class="text-white/30 font-bold uppercase tracking-widest text-xs mb-12">Heute</p>
        <button id="task-detail-action-btn" onclick="toggleTaskFromDetail()"
            class="w-full max-w-sm py-5 rounded-2xl bg-white/5 border border-white/10 text-white font-black uppercase tracking-[0.2em] active:scale-95 transition-all">
            <span id="task-detail-btn-text">Als erledigt markieren</span>
        </button>
    </div>
</div>
</div>

<!-- INVITE FRIENDS MODAL -->
<div id="invite-friends-modal" class="hidden fixed inset-0 z-[130] bg-background-dark flex flex-col overflow-hidden">
    <header
        class="flex items-center justify-between px-6 h-20 border-b border-white/5 bg-background-dark/95 backdrop-blur-xl shrink-0">
        <button onclick="closeInviteModal()"
            class="size-11 rounded-2xl bg-white/5 flex items-center justify-center text-white active:scale-90 transition-all border border-white/5">
            <span class="material-symbols-outlined" style="font-size: 24px;">close</span>
        </button>
        <h2 class="text-white font-black tracking-widest uppercase text-lg text-center">Freunde Einladen</h2>
        <div class="size-11"></div> <!-- Spacer -->
    </header>
    <div class="flex-1 overflow-y-auto p-6 no-scrollbar">
        <p class="text-center text-white/50 text-sm mb-6">W√§hle Freunde aus, die du zu diesem Habit einladen m√∂chtest.
        </p>
        <div id="invite-friends-list" class="space-y-3">
            <!-- Friend items injected via JS -->
        </div>
    </div>
    <div class="p-6 border-t border-white/5 bg-background-dark/95">
        <button onclick="submitInvitations()"
            class="w-full py-5 rounded-[2rem] bg-primary text-background-dark font-black uppercase tracking-[0.2em] shadow-[0_15px_30px_rgba(19,236,91,0.25)] hover:brightness-110 active:scale-[0.97] transition-all">
            Einladung senden
        </button>
    </div>
</div>

<script>
    const INITIAL_STATE = {
        habits: {{ habits | tojson }},
    tasks: { { tasks | tojson } },
    streak: { { streak } }
    };
</script>
<script src="{{ url_for('static', filename='app.js') }}?v={{ version }}"></script>

<style>
    .day-check-modal.selected {
        background-color: #13ec5b !important;
        color: #102216 !important;
        box-shadow: 0 4px 15px rgba(19, 236, 91, 0.4);
    }

    .freq-btn.active {
        background-color: #1a2e22;
        color: white;
        font-weight: 900;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        border-color: rgba(255, 255, 255, 0.1);
    }

    @keyframes slide-up {
        from {
            transform: translateY(100%);
        }

        to {
            transform: translateY(0);
        }
    }

    .animate-slide-up {
        animation: slide-up 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    }
</style>
{% endblock %}