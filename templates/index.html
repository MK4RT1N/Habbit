{% extends "layout.html" %}

{% block content %}
<!-- Weekly Calendar Strip -->
<div class="flex overflow-x-auto no-scrollbar gap-3 px-4 pb-4 pt-1">
    <!-- Static Calendar Mockup (Dynamic would require Python Logic injection for dates) -->
    <!-- We simulate "today" as active -->
    {% set days = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'] %}

    <!-- Simple logic rendering just a few cards for visual style as requested -->
    <button
        class="flex flex-col items-center justify-center min-w-[60px] h-[72px] rounded-2xl bg-surface-light dark:bg-surface-dark border border-transparent text-gray-400">
        <span class="text-xs font-medium mb-1">Gestern</span>
        <span class="text-lg font-bold"></span>
    </button>

    <button
        class="flex flex-col items-center justify-center min-w-[60px] h-[72px] rounded-2xl bg-primary text-[#0d1b12] shadow-[0_0_15px_rgba(19,236,91,0.4)] transform scale-105 transition-all">
        <span class="text-xs font-bold mb-1">Heute</span>
        <span class="text-lg font-extrabold"></span>
        <div class="size-1 bg-[#0d1b12] rounded-full mt-1"></div>
    </button>

    <button
        class="flex flex-col items-center justify-center min-w-[60px] h-[72px] rounded-2xl bg-surface-light dark:bg-surface-dark border border-transparent text-gray-400">
        <span class="text-xs font-medium mb-1">Morgen</span>
        <span class="text-lg font-bold"></span>
    </button>
</div>

<!-- Main Content -->
<div class="flex flex-col gap-6 p-4">
    <!-- Hero Progress Card -->
    <div class="relative overflow-hidden rounded-2xl bg-surface-dark shadow-soft group">
        <div class="absolute inset-0 z-0 bg-cover bg-center opacity-60 mix-blend-overlay"
            style='background-image: url("https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=2670&auto=format&fit=crop");'>
        </div>
        <div class="absolute inset-0 z-0 bg-gradient-to-t from-black/80 to-transparent"></div>
        <div class="relative z-10 p-5 flex flex-col gap-4">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-primary text-xs font-bold uppercase tracking-wider mb-1">Aktueller Streak</p>
                    <h3 class="text-white text-2xl font-bold leading-tight max-w-[200px]" id="streak-display-hero">{{
                        streak }} Tage ðŸ”¥</h3>
                </div>
                <div class="relative size-16 flex items-center justify-center">
                    <svg class="size-full -rotate-90 transform" viewbox="0 0 36 36">
                        <path class="text-white/20"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none" stroke="currentColor" stroke-width="4"></path>
                        <!-- Progress Circle Dynamic -->
                        <path id="hero-circle-path" class="text-primary drop-shadow-[0_0_4px_rgba(19,236,91,0.8)]"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none" stroke="currentColor" stroke-dasharray="0, 100" stroke-linecap="round"
                            stroke-width="4"></path>
                    </svg>
                    <span id="hero-percentage" class="absolute text-sm font-bold text-white">0%</span>
                </div>
            </div>
            <div class="flex flex-col gap-2">
                <div class="flex justify-between text-xs font-medium text-white/80">
                    <span id="hero-progress-text">0 von 0 erledigt</span>
                </div>
                <!-- Linear Progress -->
                <div class="h-2 w-full bg-white/20 rounded-full overflow-hidden">
                    <div id="hero-bar" class="h-full bg-primary shadow-[0_0_10px_rgba(19,236,91,0.6)]"
                        style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Tasks Section (New) -->
    <div>
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-[#0d1b12] dark:text-white text-lg font-bold leading-tight">Tages-Aufgaben</h3>
        </div>

        <!-- Input Form Styled -->
        <div class="flex gap-2 mb-4 bg-surface-light dark:bg-surface-dark p-2 rounded-xl shadow-sm">
            <select id="new-task-date"
                class="bg-transparent border-none text-sm text-[#0d1b12] dark:text-white focus:ring-0 font-medium max-w-[100px]">
                <!-- Populated by JS -->
            </select>
            <input type="text" id="new-task-input" placeholder="+ Aufgabe..."
                class="bg-transparent border-none text-sm text-[#0d1b12] dark:text-white focus:ring-0 flex-grow placeholder:text-gray-500"
                onkeypress="handleTaskKey(event)">
            <button onclick="submitNewTask()" class="text-primary font-bold px-2">OK</button>
        </div>

        <div id="task-list" class="flex flex-col gap-3">
            <!-- Tasks injected by JS -->
        </div>
    </div>

    <!-- Habits Section -->
    <div>
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-[#0d1b12] dark:text-white text-lg font-bold leading-tight">Heutige Habits</h3>
            <button onclick="openAddHabitModal()" class="text-sm font-semibold text-primary">Neuer Habit</button>
        </div>
        <div class="flex flex-col gap-3" id="habit-list">
            <!-- Habits injected by JS -->
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<div class="fixed bottom-6 right-5 z-40">
    <button onclick="openAddHabitModal()"
        class="flex items-center justify-center size-14 rounded-full bg-[#0d1b12] text-primary shadow-[0_4px_14px_rgba(0,0,0,0.4)] hover:scale-105 transition-transform active:scale-95">
        <span class="material-symbols-outlined text-3xl">add</span>
    </button>
</div>

<!-- Modal (Re-styled for Tailwind) -->
<div id="add-habit-modal"
    class="hidden fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex justify-center items-center p-4">
    <div class="bg-surface-light dark:bg-surface-dark w-full max-w-sm rounded-2xl p-6 shadow-2xl flex flex-col gap-4">
        <h3 class="text-xl font-bold text-[#0d1b12] dark:text-white">Neue Gewohnheit</h3>

        <div class="flex flex-col gap-2">
            <label class="text-xs text-gray-500 font-bold uppercase">Name</label>
            <input type="text" id="new-habit-text"
                class="rounded-lg bg-gray-50 dark:bg-black/20 border-transparent focus:border-primary focus:ring-primary text-[#0d1b12] dark:text-white"
                placeholder="z.B. Joggen">
        </div>

        <div class="flex gap-4">
            <div class="flex flex-col gap-2 flex-1">
                <label class="text-xs text-gray-500 font-bold uppercase">Ziel</label>
                <input type="number" id="new-habit-target" value="1" min="1"
                    class="rounded-lg bg-gray-50 dark:bg-black/20 border-transparent focus:border-primary text-[#0d1b12] dark:text-white">
            </div>
            <div class="flex flex-col gap-2 flex-1">
                <label class="text-xs text-gray-500 font-bold uppercase">HÃ¤ufigkeit</label>
                <select id="new-habit-freq" onchange="toggleDaysInput()"
                    class="rounded-lg bg-gray-50 dark:bg-black/20 border-transparent focus:border-primary text-[#0d1b12] dark:text-white">
                    <option value="daily">TÃ¤glich</option>
                    <option value="specific">Bestimmte Tage</option>
                    <option value="weekly_flex">WÃ¶chentlich</option>
                </select>
            </div>
        </div>

        <div id="days-selector" class="hidden flex-wrap gap-2">
            <div class="day-check size-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-xs cursor-pointer"
                onclick="toggleDay(0)" id="day-0">Mo</div>
            <div class="day-check size-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-xs cursor-pointer"
                onclick="toggleDay(1)" id="day-1">Di</div>
            <div class="day-check size-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-xs cursor-pointer"
                onclick="toggleDay(2)" id="day-2">Mi</div>
            <div class="day-check size-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-xs cursor-pointer"
                onclick="toggleDay(3)" id="day-3">Do</div>
            <div class="day-check size-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-xs cursor-pointer"
                onclick="toggleDay(4)" id="day-4">Fr</div>
            <div class="day-check size-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-xs cursor-pointer"
                onclick="toggleDay(5)" id="day-5">Sa</div>
            <div class="day-check size-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-xs cursor-pointer"
                onclick="toggleDay(6)" id="day-6">So</div>
        </div>

        <div class="flex flex-col gap-2">
            <label class="text-xs text-gray-500 font-bold uppercase">Teilen mit</label>
            <div id="friends-selector" class="h-24 overflow-y-auto bg-gray-50 dark:bg-black/20 rounded-lg p-2">
                <!-- Friends -->
            </div>
        </div>

        <button onclick="submitNewHabit()"
            class="bg-primary text-[#0d1b12] font-bold py-3 rounded-xl shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all">Erstellen</button>
        <button onclick="getEl('add-habit-modal').style.display='none'" class="text-gray-500 text-sm">Abbrechen</button>
    </div>
</div>

<!-- Modal Details -->
<div id="habit-details-modal"
    class="hidden fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex justify-center items-center p-4">
    <div class="bg-surface-light dark:bg-surface-dark w-full max-w-sm rounded-2xl p-6 shadow-2xl flex flex-col gap-4">
        <h3 id="detail-title" class="text-xl font-bold text-[#0d1b12] dark:text-white">Details</h3>
        <div class="flex flex-col gap-1">
            <div class="flex justify-between text-sm">
                <span>Fortschritt</span>
                <span id="detail-stats">0/1</span>
            </div>
            <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                <div id="detail-progress" class="h-full bg-primary"></div>
            </div>
        </div>
        <div class="bg-gray-50 dark:bg-black/20 p-3 rounded-xl flex items-end gap-1 h-24" id="detail-history">
        </div>
        <button onclick="closeDetails()"
            class="bg-gray-200 dark:bg-gray-700 text-[#0d1b12] dark:text-white py-2 rounded-xl">SchlieÃŸen</button>
    </div>
</div>

<script>
    const INITIAL_STATE = {
        habits: {{ habits | tojson }},
    tasks: { { tasks | tojson } },
    streak: { { streak } }
    };
</script>
<script src="{{ url_for('static', filename='app.js') }}"></script>
<style>
    /* Helper classes for JS toggles since we replaced CSS */
    .day-check.selected {
        background-color: #13ec5b !important;
        color: #0d1b12 !important;
        font-weight: bold;
    }
</style>
{% endblock %}